var x=Object.defineProperty;var v=(s,t,i)=>t in s?x(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i;var l=(s,t,i)=>v(s,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(e){if(e.ep)return;e.ep=!0;const r=i(e);fetch(e.href,r)}})();class S{constructor(t,i,o){l(this,"left",!1);l(this,"right",!1);l(this,"dragging",!1);window.addEventListener("keydown",e=>{(e.key==="ArrowLeft"||e.key==="a"||e.key==="A")&&(this.left=!0),(e.key==="ArrowRight"||e.key==="d"||e.key==="D")&&(this.right=!0)}),window.addEventListener("keyup",e=>{(e.key==="ArrowLeft"||e.key==="a"||e.key==="A")&&(this.left=!1),(e.key==="ArrowRight"||e.key==="d"||e.key==="D")&&(this.right=!1)}),t.addEventListener("pointerdown",e=>{this.dragging=!0,o();const r=t.getBoundingClientRect(),n=(e.clientX-r.left)/r.width;i(Math.max(0,Math.min(1,n)))}),t.addEventListener("pointerup",()=>{this.dragging=!1}),t.addEventListener("pointerleave",()=>{this.dragging=!1}),t.addEventListener("pointermove",e=>{if(this.dragging||e.pointerType==="mouse"){const r=t.getBoundingClientRect(),n=(e.clientX-r.left)/r.width;i(Math.max(0,Math.min(1,n)))}})}}const a={W:960,H:540},f={DROP_RATE:.15,WIDEN_DURATION_MS:2e4,STICKY_DURATION_MS:15e3,SCALE_STEP:.25,SCALE_MAX:1.6},d={PADDLE:8,BALL_MIN:1,BALL_MAX:2,POWERUP_FALL:1},p={START:"https://code.anton-atom.com/count/new-year/api/start",TOP:"https://code.anton-atom.com/count/new-year/api/scores?limit=5",SUBMIT:"https://code.anton-atom.com/count/new-year/api/scores"};function A(){const e=(a.W-78)/12,r=24,n=[];for(let h=0;h<6;h++)for(let c=0;c<12;c++)n.push({x:6+c*(e+6),y:60+h*(r+6),w:e,h:r,alive:!0,hp:1});return n}function y(s,t){return s.x+s.r>t.x&&s.x-s.r<t.x+t.w&&s.y+s.r>t.y&&s.y-s.r<t.y+t.h}function k(s,t){const i=s.x-s.vx,o=s.y-s.vy,e=i<=t.x,r=i>=t.x+t.w,n=o<=t.y,h=o>=t.y+t.h;(e&&!r||r&&!e)&&(s.vx*=-1),(n&&!h||h&&!n)&&(s.vy*=-1);const c=Math.hypot(s.vx,s.vy);if(c>0){const m=s.vx/c,g=s.vy/c,u=Math.min(d.BALL_MAX,Math.max(d.BALL_MIN,c));s.vx=m*u,s.vy=g*u}}function L(s,t,i){if(Math.random()>f.DROP_RATE)return;const o=Math.random();let e="widen";o<.4?e="widen":o<.8?e="multi":e="sticky",s.push({x:t,y:i,w:18,h:18,vy:d.POWERUP_FALL,kind:e,dead:!1})}function b(s,t){s==="widen"?t.widen(f.WIDEN_DURATION_MS):s==="multi"?t.multiball():s==="sticky"&&t.sticky(f.STICKY_DURATION_MS)}class T{constructor(){l(this,"data",[])}async start(){return{nonce:Math.random().toString(36).slice(2)}}async top(t){return this.data.slice().sort((i,o)=>o.score-i.score).slice(0,t)}async submit(t){return!t.name||t.name.length<3?{ok:!1,error:"invalid name"}:(this.data.push({name:t.name,score:t.score,created_at:new Date().toISOString()}),{ok:!0})}}class M{async start(){try{const t=await fetch(p.START);if(!t.ok)throw new Error(`Start failed: ${t.status} ${t.statusText}`);return t.json()}catch(t){throw console.error("API start error:",t),t}}async top(t){try{const o=`${p.TOP.split("?")[0]}?limit=${t}`,e=await fetch(o);if(!e.ok)throw new Error(`Top failed: ${e.status} ${e.statusText}`);const r=await e.json();return console.log(`Fetched ${r.length} scores from ${o}`),r}catch(i){throw console.error("API top scores error:",i),i}}async submit(t){try{const i=await fetch(p.SUBMIT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const o=await i.text();throw new Error(`Submit failed: ${i.status} ${i.statusText} - ${o}`)}return i.json()}catch(i){throw console.error("API submit error:",i),i}}}class P{constructor(t=!1){l(this,"api");l(this,"topScores",[]);this.api=t?new T:new M,console.log("Leaderboard API:",t?"MOCK (local)":"HTTP (real database)"),t||console.log("API Endpoints:",p)}async startSession(){const{nonce:t}=await this.api.start();return t}async fetchTop(t=5){try{return this.topScores=await this.api.top(t),console.log("Fetched top scores from API:",this.topScores),this.topScores}catch(i){return console.error("Failed to fetch top scores from API:",i),[]}}getTopScores(){return this.topScores}async submitScoreFlow(t,i){const o=typeof window<"u"?prompt("Enter name for leaderboard (3â€“12 chars):","Player"):"Player";if(!o)return;const e=o.trim().slice(0,12);try{const r=await this.api.submit({name:e,score:t,nonce:i});r.ok?(alert("Score submitted!"),await this.fetchTop(5)):alert("Submit failed: "+(r.error||"unknown"))}catch(r){alert("Submit failed: "+(r instanceof Error?r.message:"unknown"))}}}function E(s,t,i,o){s.fillStyle="#fff",s.font="16px system-ui",s.fillText(`Score: ${t}`,12,22),i&&(s.fillStyle="#10b981",s.fillText("Wide",12,44)),o&&(s.fillStyle="#eab308",s.fillText("Sticky",i?70:12,44))}function O(s,t,i){if(s.fillStyle="rgba(0,0,0,0.8)",s.fillRect(0,0,a.W,a.H),s.fillStyle="#fff",s.font="bold 32px system-ui",s.textAlign="center",s.fillText("Game Over",a.W/2,a.H/2-120),s.font="20px system-ui",s.fillText(`Final Score: ${t}`,a.W/2,a.H/2-80),i.length>0){s.font="bold 18px system-ui",s.fillText("Top Scores",a.W/2,a.H/2-40),s.font="14px system-ui",s.textAlign="left";const o=a.H/2-10,e=20,r=Math.min(5,i.length);for(let n=0;n<r;n++){const h=i[n],c=o+n*e;s.fillText(`${n+1}. ${h.name}: ${h.score}`,a.W/2-100,c)}}s.textAlign="center",s.font="16px system-ui",s.fillText("Click to restart",a.W/2,a.H/2+100)}class I{constructor(t){l(this,"ctx");l(this,"input");l(this,"dpr",Math.min(window.devicePixelRatio||1,2));l(this,"running",!0);l(this,"gameOver",!1);l(this,"score",0);l(this,"session",{nonce:null,startedAt:performance.now(),hits:0,bricks:0});l(this,"paddle",{x:a.W/2-60,y:a.H-28,w:120,h:16,speed:d.PADDLE,scale:1,widenUntil:0,stickyUntil:0});l(this,"balls",[]);l(this,"bricks",[]);l(this,"powerups",[]);l(this,"lb",new P);l(this,"accumulator",0);l(this,"last",performance.now());l(this,"loop",()=>{const t=performance.now();let i=(t-this.last)/1e3;this.last=t;const o=1/120;for(this.accumulator+=Math.min(i,.1);this.accumulator>=o;)this.update(o),this.accumulator-=o;this.draw(),requestAnimationFrame(this.loop)});this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Canvas 2D not supported");this.ctx=i,this.input=new S(t,o=>{const e=this.paddle.w*this.paddle.scale;this.paddle.x=o*a.W-e/2},()=>this.releaseOrAction()),window.addEventListener("resize",()=>this.resize()),this.resize(),t.addEventListener("click",()=>{this.gameOver&&this.reset()}),this.reset()}async start(){try{const t=await this.lb.startSession();this.session.nonce=t}catch(t){console.warn("Failed to start session:",t)}try{await this.lb.fetchTop(5)}catch(t){console.error("Failed to fetch top scores:",t)}this.loop()}resize(){if(!this.canvas.parentElement)return;const i=window.innerWidth,o=window.innerHeight;this.canvas.style.width=i+"px",this.canvas.style.height=o+"px",this.canvas.width=Math.floor(i*this.dpr),this.canvas.height=Math.floor(o*this.dpr),this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0)}reset(){this.score=0,this.session={nonce:this.session.nonce,startedAt:performance.now(),hits:0,bricks:0},this.paddle={x:a.W/2-60,y:a.H-28,w:120,h:16,speed:d.PADDLE,scale:1,widenUntil:0,stickyUntil:0},this.balls=[{x:a.W/2,y:a.H-60,r:8,vx:3,vy:-4,stuck:!0}],this.bricks=A(),this.powerups=[],this.gameOver=!1,this.running=!0}releaseOrAction(){for(const t of this.balls)t.stuck&&(t.stuck=!1)}update(t){if(!this.running)return;const i=performance.now();this.input.left&&(this.paddle.x-=this.paddle.speed),this.input.right&&(this.paddle.x+=this.paddle.speed);const o=this.paddle.w*this.paddle.scale;this.paddle.x=Math.max(0,Math.min(a.W-o,this.paddle.x)),this.paddle.widenUntil&&i>this.paddle.widenUntil&&(this.paddle.scale=1,this.paddle.widenUntil=0),this.paddle.stickyUntil&&i>this.paddle.stickyUntil&&(this.paddle.stickyUntil=0);for(const e of this.balls){if(e.stuck){e.x=this.paddle.x+o/2,e.y=this.paddle.y-e.r-.1;continue}e.x+=e.vx,e.y+=e.vy,(e.x<e.r||e.x>a.W-e.r)&&(e.vx*=-1,e.x=Math.max(e.r,Math.min(a.W-e.r,e.x))),e.y<e.r&&(e.vy*=-1,e.y=e.r);const r={x:this.paddle.x,y:this.paddle.y,w:o,h:this.paddle.h};if(y(e,r)&&e.vy>0){const n=(e.x-(r.x+r.w/2))/(r.w/2),h=Math.min(d.BALL_MAX,Math.max(d.BALL_MIN,Math.hypot(e.vx,e.vy))),c=n*.9;e.vx=h*Math.sin(c),e.vy=-Math.abs(h*Math.cos(c)),e.y=r.y-e.r-.1,this.session.hits++,this.paddle.stickyUntil&&i<this.paddle.stickyUntil&&(e.stuck=!0)}for(const n of this.bricks)if(n.alive&&y(e,n)){k(e,n),n.hp-=1,n.hp<=0?(n.alive=!1,this.score+=50,this.session.bricks++,L(this.powerups,n.x+n.w/2-9,n.y+n.h/2-9)):this.score+=10;break}}this.balls=this.balls.filter(e=>e.y<=a.H+40);for(const e of this.powerups){e.y+=e.vy;const r={x:this.paddle.x,y:this.paddle.y,w:o,h:this.paddle.h},n=e.x<r.x+r.w&&e.x+e.w>r.x&&e.y<r.y+r.h&&e.y+e.h>r.y;e.y>a.H+24&&(e.dead=!0),!e.dead&&n&&(b(e.kind,this),e.dead=!0)}this.powerups=this.powerups.filter(e=>!e.dead),this.balls.length===0&&!this.gameOver&&(this.gameOver=!0,this.running=!1,this.lb.submitScoreFlow(this.score,this.session.nonce).catch(e=>{console.warn("Failed to submit score:",e)}))}draw(){const t=this.ctx,i=this.canvas.width/this.dpr,o=this.canvas.height/this.dpr;t.clearRect(0,0,i,o),t.fillStyle="#0b1220",t.fillRect(0,0,i,o),t.save(),t.scale(i/a.W,o/a.H),t.fillStyle="#94a3b8";for(const r of this.bricks)r.alive&&t.fillRect(r.x,r.y,r.w,r.h);t.fillStyle="#22d3ee";const e=this.paddle.w*this.paddle.scale;t.fillRect(this.paddle.x,this.paddle.y,e,this.paddle.h),t.fillStyle="#f97316";for(const r of this.balls)t.beginPath(),t.arc(r.x,r.y,r.r,0,Math.PI*2),t.fill();for(const r of this.powerups)r.kind==="multi"?t.fillStyle="#f43f5e":r.kind==="widen"?t.fillStyle="#10b981":t.fillStyle="#eab308",t.fillRect(r.x,r.y,r.w,r.h);E(t,this.score,this.paddle.widenUntil>performance.now(),this.paddle.stickyUntil>performance.now()),this.gameOver&&O(t,this.score,this.lb.getTopScores()),t.restore()}widen(t){this.paddle.scale=Math.min(this.paddle.scale+f.SCALE_STEP,f.SCALE_MAX),this.paddle.widenUntil=performance.now()+t}sticky(t){this.paddle.stickyUntil=performance.now()+t}multiball(){const t=[];for(const i of this.balls)i.stuck||t.push({x:i.x,y:i.y,r:i.r,vx:-i.vx,vy:i.vy,stuck:!1});this.balls.push(...t)}onClickRestart(){this.gameOver&&this.reset()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w();function w(){try{const s=document.getElementById("game");if(!s){console.error("Canvas element not found");return}new I(s).start().catch(i=>{console.error("Failed to start game:",i)})}catch(s){console.error("Game initialization error:",s)}}
